
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>simoneb's blog</title>
  <meta name="author" content="Simone Busoli">

  
  <meta name="description" content="In the previous post of this series we did a small improvement to the state monad implementation by generalizing it over the type of the state.
This &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://simoneb.github.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="http://feeds.feedburner.com/simoneb" rel="alternate" title="simoneb's blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-27143372-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">simoneb's blog</a></h1>
  
    <h2>about design, development, profession and avoidance of fluff</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/simoneb" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:simoneb.github.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <!--li><a href="/">Home</a></li-->
  <li><a href="/projects">Projects</a></li>
  <li><a href="/about">About</a></li>
  <!--li><a href="/blog/archives">Archives</a></li-->
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/13/labeling-trees-exercise-2/">Labeling Trees - Exercise 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-13T01:28:00+02:00" pubdate data-updated="true">Apr 13<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the <a href="/blog/2013/04/07/labeling-trees-exercise-1">previous post</a> of this series we did a small improvement to the state monad implementation by generalizing it over the type of the state.
This is not exactly a requirement for labeling trees as the state can be simply an integer, but it&#8217;s a more natural choice now that we tackle the second exercise.</p>

<blockquote><p>Go from labeling a tree to doing a constrained
container computation, as in WPF. Give everything a
bounding box, and size subtrees to fit inside their
parents, recursively.</p></blockquote>

<p>As you know the exercises come without any solution, so let&#8217;s try to understand what we need to do here.
Because we&#8217;re talking about binary trees let&#8217;s assume that the requirement is to perform the constrained container computation based on containers with two children,
where each child can either be another container or a terminal element, like a text block.</p>

<p>By translating it to WPF as suggested in the assignment we can represent a branch as a <code>Grid</code> with two rows and a single column.
Each row&#8217;s unique cell can contain either another grid with the same characteristics or a <code>TextBlock</code>.
The layout features of a grid match exactly the solution to the problem we&#8217;re asked to solve, as child elements of grid cells expand to match the size of their parent.</p>

<p>Starting with the same simple tree we used as a sample throughout the series:</p>

<figure class='code'><figcaption><span>A simple tree  (a-simple-tree.cs)</span> <a href='/downloads/code/monads/a-simple-tree.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'>                                <span class="c1">//  tree.Show() outputs:</span>
</span><span class='line'><span class="kt">var</span> <span class="n">tree</span> <span class="p">=</span> <span class="n">branch</span><span class="p">(</span>              <span class="c1">//  Branch:</span>
</span><span class='line'>            <span class="n">leaf</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">),</span>          <span class="c1">//    Leaf: a</span>
</span><span class='line'>            <span class="n">branch</span><span class="p">(</span>             <span class="c1">//    Branch:</span>
</span><span class='line'>              <span class="n">branch</span><span class="p">(</span>           <span class="c1">//      Branch:</span>
</span><span class='line'>                <span class="n">leaf</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">),</span>      <span class="c1">//        Leaf: b</span>
</span><span class='line'>                <span class="n">leaf</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">)),</span>     <span class="c1">//        Leaf: c</span>
</span><span class='line'>              <span class="n">leaf</span><span class="p">(</span><span class="s">&quot;d&quot;</span><span class="p">)));</span>      <span class="c1">//      Leaf: d</span>
</span><span class='line'>
</span><span class='line'><span class="n">tree</span><span class="p">.</span><span class="n">Show</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>we can transform it into this simple WPF markup, as described earlier:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'><span class="nt">&lt;Grid&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Grid.RowDefinitions&gt;</span>
</span><span class='line'>        <span class="nt">&lt;RowDefinition&gt;&lt;/RowDefinition&gt;</span>
</span><span class='line'>        <span class="nt">&lt;RowDefinition&gt;&lt;/RowDefinition&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Grid.RowDefinitions&gt;</span>
</span><span class='line'>    <span class="nt">&lt;TextBlock</span> <span class="na">Grid.Row=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>a<span class="nt">&lt;/TextBlock&gt;</span>
</span><span class='line'>    <span class="nt">&lt;Grid</span> <span class="na">Grid.Row=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Grid.RowDefinitions&gt;</span>
</span><span class='line'>            <span class="nt">&lt;RowDefinition&gt;&lt;/RowDefinition&gt;</span>
</span><span class='line'>            <span class="nt">&lt;RowDefinition&gt;&lt;/RowDefinition&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Grid.RowDefinitions&gt;</span>
</span><span class='line'>        <span class="nt">&lt;Grid</span> <span class="na">Grid.Row=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>            <span class="nt">&lt;Grid.RowDefinitions&gt;</span>
</span><span class='line'>                <span class="nt">&lt;RowDefinition&gt;&lt;/RowDefinition&gt;</span>
</span><span class='line'>                <span class="nt">&lt;RowDefinition&gt;&lt;/RowDefinition&gt;</span>
</span><span class='line'>            <span class="nt">&lt;/Grid.RowDefinitions&gt;</span>
</span><span class='line'>            <span class="nt">&lt;TextBlock</span> <span class="na">Grid.Row=</span><span class="s">&quot;0&quot;</span><span class="nt">&gt;</span>b<span class="nt">&lt;/TextBlock&gt;</span>
</span><span class='line'>            <span class="nt">&lt;TextBlock</span> <span class="na">Grid.Row=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>c<span class="nt">&lt;/TextBlock&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/Grid&gt;</span>
</span><span class='line'>        <span class="nt">&lt;TextBlock</span> <span class="na">Grid.Row=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>d<span class="nt">&lt;/TextBlock&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/Grid&gt;</span>
</span><span class='line'><span class="nt">&lt;/Grid&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result of this markup, along with some additional styling and a bit of logic to outline the bounds of each cell and display its box size, is shown below.
The full code of this example is available as a ready-to-run LINQPad query <a href="http://share.linqpad.net/f2d3sg.linq">here</a>.</p>

<p><img class="center" src="/downloads/images/wpf_grid.png" title="WPF grid sample" ></p>

<p>As you can see the children of grid cells automatically expand to fit their parent&#8217;s size.
More precisely, each grid row gets 50% of the height of its parent, regardless of the contents.
We&#8217;ll now try to do the same monadically by adapting our data structures and labeling logic to this new case.</p>

<p>First of all we need to decide what is the type of the state we&#8217;ll be carrying around.
Intuitively, each time we branch a grid into its two rows we allocate 50% of the available height to each of them, therefore the state will certainly include the available height.
Although not strictly needed in this scenario let&#8217;s make it a little more realistic by including the width as well, and we&#8217;ll call a structure containing two such values a <code>Box</code>.
With this little piece of information we can already define the signature of our function which, similarly to the previous <code>MLabel</code>, will represent the entry point for the constrained box computation.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Tree</span><span class="p">&lt;</span><span class="n">StateContent</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">MConstrainedBox</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Tree</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">tree</span><span class="p">,</span> <span class="n">Box</span> <span class="n">box</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The function takes a tree, which in this case we can imagine being a visual tree of graphic elements, and an initial box size (our initial state), representing the size of the root element.
The return value is a tree whose generic argument is a tuple of state-content values.
The state is the <code>Box</code> representing the size allocated to that tree and the value is the generic parameter <code>T</code> that we&#8217;re currently filling with characters to distinguish a leaf from another leaf.</p>

<p>As we did with the labeling problem the entry function will finally delegate to a helper function that will call itself recursively. We can thus define the body of the previous function as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Tree</span><span class="p">&lt;</span><span class="n">StateContent</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">MConstrainedBox</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Tree</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">tree</span><span class="p">,</span> <span class="n">Box</span> <span class="n">box</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">MConstrainedBox1</span><span class="p">(</span><span class="n">tree</span><span class="p">).</span><span class="n">RunWithState</span><span class="p">(</span><span class="n">box</span><span class="p">).</span><span class="n">Item2</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>No big surprises here as the juice is actually in the body of the <code>MConstrainedBox1</code> function, in the same way as it previously was in <code>MLabel1</code>. Let&#8217;s start by defining its signature, which we can infer from above.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">S</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">StateContent</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;&gt;&gt;</span> <span class="n">MConstrainedBox1</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Tree</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">tree</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Not much else to do except reasoning about how to solve the problem of assigning box sizes to tree leaves according to the rules described earlier. The process is overall simple, let&#8217;s outline the steps.</p>

<p>If the current tree is a <em>leaf</em> then extract the state value using a proper <code>getState</code> function similar to what we used in the labeling scenario. The main difference here is that when we encounter leaves we do not need to update any state but only extract it from the monad and attach it to the new leaf we create.</p>

<p>If the current tree is a <em>branch</em> then:</p>

<ol>
<li>update the state by halving the height of the current box</li>
<li>recurse over the left branch</li>
<li>recurse over the right branch</li>
<li>update the state by doubling the height of the current box</li>
<li>return an instance of the state monad whose value is a branch with the results of steps 2 and 3 as the left and right trees, respectively</li>
</ol>


<p>Let&#8217;s go through a simple example to understand better.
Assuming to start with a box of size 200 x 400 (W x H) and that the root element of the tree we want to process is a branch,
we halve the available height and process the left and right trees using 200 as the available height for each of them.
If at some point we come across a leaf we use whatever current value of the state we have at that point during the computation
(if both left and right trees are leaves then each of them will get a height of 200). When we&#8217;re done with the two trees we restore the original height by multiplying it by two.
This leads exactly to the solution we&#8217;re looking for.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">StateContent</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;&gt;&gt;</span> <span class="n">MConstrainedBox1</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Tree</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">tree</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">tree</span> <span class="k">is</span> <span class="n">Leaf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">lf</span> <span class="p">=</span> <span class="n">tree</span> <span class="k">as</span> <span class="n">Leaf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">getState</span> <span class="p">=</span> <span class="k">new</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">Box</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">RunWithState</span> <span class="p">=</span> <span class="n">b0</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">b0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nf">Bind</span><span class="p">(</span><span class="n">getState</span><span class="p">,</span> <span class="n">b0</span> <span class="p">=&gt;</span>
</span><span class='line'>                    <span class="n">Return</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">StateContent</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;&gt;&gt;(</span><span class="n">leaf</span><span class="p">(</span><span class="n">stateContent</span><span class="p">(</span><span class="n">b0</span><span class="p">,</span> <span class="n">lf</span><span class="p">.</span><span class="n">Value</span><span class="p">))));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">br</span> <span class="p">=</span> <span class="n">tree</span> <span class="k">as</span> <span class="n">Branch</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">halveHeight</span> <span class="p">=</span> <span class="k">new</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">Box</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">RunWithState</span> <span class="p">=</span> <span class="n">b0</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="k">new</span> <span class="n">Box</span><span class="p">(</span><span class="n">b0</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">b0</span><span class="p">.</span><span class="n">Height</span><span class="p">/</span><span class="m">2</span><span class="p">),</span> <span class="n">b0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">doubleHeight</span> <span class="p">=</span> <span class="k">new</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">Box</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">RunWithState</span> <span class="p">=</span> <span class="n">b0</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="k">new</span> <span class="n">Box</span><span class="p">(</span><span class="n">b0</span><span class="p">.</span><span class="n">Width</span><span class="p">,</span> <span class="n">b0</span><span class="p">.</span><span class="n">Height</span><span class="p">*</span><span class="m">2</span><span class="p">),</span> <span class="n">b0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nf">Bind</span><span class="p">(</span><span class="n">halveHeight</span><span class="p">,</span> <span class="n">_</span> <span class="p">=&gt;</span> <span class="n">Bind</span><span class="p">(</span><span class="n">MConstrainedBox1</span><span class="p">(</span><span class="n">br</span><span class="p">.</span><span class="n">Left</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">left</span> <span class="p">=&gt;</span> <span class="n">Bind</span><span class="p">(</span><span class="n">MConstrainedBox1</span><span class="p">(</span><span class="n">br</span><span class="p">.</span><span class="n">Right</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">right</span> <span class="p">=&gt;</span> <span class="n">Bind</span><span class="p">(</span><span class="n">doubleHeight</span><span class="p">,</span>  <span class="n">__</span> <span class="p">=&gt;</span>
</span><span class='line'>                    <span class="n">Return</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">StateContent</span><span class="p">&lt;</span><span class="n">Box</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;&gt;&gt;(</span><span class="n">branch</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))))));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now if we run the computation against the same old tree:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">tree</span> <span class="p">=</span> <span class="n">branch</span><span class="p">(</span>
</span><span class='line'>               <span class="n">leaf</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">),</span>
</span><span class='line'>               <span class="n">branch</span><span class="p">(</span>
</span><span class='line'>                   <span class="n">branch</span><span class="p">(</span>
</span><span class='line'>                       <span class="n">leaf</span><span class="p">(</span><span class="s">&quot;b&quot;</span><span class="p">),</span>
</span><span class='line'>                       <span class="n">leaf</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">)),</span>
</span><span class='line'>                   <span class="n">leaf</span><span class="p">(</span><span class="s">&quot;d&quot;</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'><span class="n">MConstrainedBox</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span> <span class="k">new</span> <span class="n">Box</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="m">400</span><span class="p">)).</span><span class="n">Show</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<p>the result we obtain is the same we obtained using WPF:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Branch</span><span class="p">:</span>
</span><span class='line'>  <span class="n">Leaf</span><span class="p">:</span> <span class="p">{</span> <span class="n">State</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Width</span> <span class="p">=</span> <span class="m">200</span><span class="p">,</span> <span class="n">Height</span> <span class="p">=</span> <span class="m">200</span> <span class="p">},</span> <span class="n">Value</span> <span class="p">=</span> <span class="n">a</span> <span class="p">}</span>
</span><span class='line'>  <span class="n">Branch</span><span class="p">:</span>
</span><span class='line'>    <span class="n">Branch</span><span class="p">:</span>
</span><span class='line'>      <span class="n">Leaf</span><span class="p">:</span> <span class="p">{</span> <span class="n">State</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Width</span> <span class="p">=</span> <span class="m">200</span><span class="p">,</span> <span class="n">Height</span> <span class="p">=</span> <span class="m">50</span> <span class="p">},</span> <span class="n">Value</span> <span class="p">=</span> <span class="n">b</span> <span class="p">}</span>
</span><span class='line'>      <span class="n">Leaf</span><span class="p">:</span> <span class="p">{</span> <span class="n">State</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Width</span> <span class="p">=</span> <span class="m">200</span><span class="p">,</span> <span class="n">Height</span> <span class="p">=</span> <span class="m">50</span> <span class="p">},</span> <span class="n">Value</span> <span class="p">=</span> <span class="n">c</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">Leaf</span><span class="p">:</span> <span class="p">{</span> <span class="n">State</span> <span class="p">=</span> <span class="p">{</span> <span class="n">Width</span> <span class="p">=</span> <span class="m">200</span><span class="p">,</span> <span class="n">Height</span> <span class="p">=</span> <span class="m">100</span> <span class="p">},</span> <span class="n">Value</span> <span class="p">=</span> <span class="n">d</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <a href="https://gist.github.com/simoneb/5332234/51fcfafaa8bf911d70cb50978d06a29d8e1492db">full source code</a> is as usual available as gist containing a LINQPad query that you can download an run right away.<br/>
In the next post we&#8217;ll do a step forward in defining a self-contained monad type before moving on to more interesting and challenging exercises.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/04/07/labeling-trees-exercise-1/">Labeling Trees - Exercise 1</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-07T19:41:00+02:00" pubdate data-updated="true">Apr 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the <a href="/blog/2013/03/31/labeling-trees-invisible-state">last post</a> of this series we learned how to label a binary tree monadically, and in doing so we discovered the state monad. I&#8217;ve collected the pieces we built incrementally last time into <a href="https://gist.github.com/simoneb/5332234/7beedb523a5c8ed2c72142000c881b3b3a890703">this gist</a> containing the whole monadic label implementation as a <a href="http://www.linqpad.net">LINQPad</a> query that you can simply copy and run. I&#8217;ll keep making changes to that gist and create links which point to specific revisions from now on.</p>

<p>As I mentioned in the <a href="/blog/2013/03/17/labeling-trees-introduction">introduction</a> I decided to write this series as a result of watching some years ago Brian Beckman talking about monads and not being able to grasp the topic at that time. Going through it again and explaining what it took me to understand it will hopefully help someone else follow the same path. Up until now we&#8217;ve rediscovered what Brian explained in his interviews, but the accompanying source code (that I&#8217;ve copied in <a href="https://gist.github.com/simoneb/627a349a1632307c301b">this gist</a> for convenience) also gave 10 assignments to the reader - without solutions - which I&#8217;m going to tackle in the remainder of this series.</p>

<p>The exercises are of varying difficulties, basically expanding on the topic of the state monad with tasks which require generalizing the pattern and applying it to solve problems other than labeling binary trees. So, without further ado, let&#8217;s move on to the first exercise.</p>

<h3>Exercise 1</h3>

<blockquote><p>generalize over the type of the state, from int
to &lt;TState>, say, so that the S type can handle any kind of
state object. Start with Labeled&lt;T> &#8211;> StateContent&lt;TState, T>, from
&#8220;label-content pair&#8221; to &#8220;state-content pair&#8221;.</p></blockquote>

<p>I rephrased the original text of the exercise a little bit so it matches our own implementation rather than Brian&#8217;s. Some type names are different as well as some design choices, but the overall concept is the same. Let&#8217;s see what this exercise is about.</p>

<p>So far we used a <code>Labeled&lt;T&gt;</code> class to represent the contents of a labeled tree - leaves, specifically. This class is a simple container of label and value pairs, where only the latter is generically parameterized via the <code>T</code> generic parameter. This exercise requires to parameterize the type of the label/state too, which is currently fixed to be an integer.  It doesn&#8217;t sound very difficult, does it? We simply come up with a new type <code>StateContent&lt;TState, T&gt;</code> which does just that, and then adapt the usages of <code>Labeled&lt;T&gt;</code> to match the new type.</p>

<p>In addition to that we&#8217;ll also have to make some changes to the <code>S&lt;T&gt;</code> class, because it&#8217;s hardcoding the type of the state to be an integer. This will in turn require some changes to the <code>MLabel1</code> function, mainly to cope with limited type inference capabilities of the C# compiler. The end result is shown in the diff below.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gu">@@ -59,10 +59,10 @@ public class Branch&lt;T&gt; : Tree&lt;T&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="gd">-public class Labeled&lt;T&gt;</span>
</span><span class='line'><span class="gi">+public class StateContent&lt;TState, T&gt;</span>
</span><span class='line'> {
</span><span class='line'><span class="gd">-    public int Label { get; private set; }</span>
</span><span class='line'><span class="gi">+    public TState State { get; private set; }</span>
</span><span class='line'>     public T Value { get; private set; }
</span><span class='line'>
</span><span class='line'><span class="gd">-    public Labeled(int label, T value)</span>
</span><span class='line'><span class="gi">+    public StateContent(TState state, T value)</span>
</span><span class='line'>     {
</span><span class='line'><span class="gd">-        Label = label;</span>
</span><span class='line'><span class="gi">+        State = state;</span>
</span><span class='line'>         Value = value;
</span><span class='line'><span class="gu">@@ -72,3 +72,3 @@ public class Labeled&lt;T&gt;</span>
</span><span class='line'>     {
</span><span class='line'><span class="gd">-        return new { Label, Value }.ToString();</span>
</span><span class='line'><span class="gi">+        return new { State, Value }.ToString();</span>
</span><span class='line'>     }
</span><span class='line'><span class="gu">@@ -86,15 +86,15 @@ public Tree&lt;T&gt; branch&lt;T&gt;(Tree&lt;T&gt; left, Tree&lt;T&gt; right)</span>
</span><span class='line'>
</span><span class='line'><span class="gd">-public Labeled&lt;T&gt; labeled&lt;T&gt;(int label, T value)</span>
</span><span class='line'><span class="gi">+public StateContent&lt;TState, T&gt; stateContent&lt;TState, T&gt;(TState state, T value)</span>
</span><span class='line'> {
</span><span class='line'><span class="gd">-    return new Labeled&lt;T&gt;(label, value);</span>
</span><span class='line'><span class="gi">+    return new StateContent&lt;TState, T&gt;(state, value);</span>
</span><span class='line'> }
</span><span class='line'>
</span><span class='line'><span class="gd">-public class S&lt;T&gt;</span>
</span><span class='line'><span class="gi">+public class S&lt;TState, T&gt;</span>
</span><span class='line'> {
</span><span class='line'><span class="gd">-    public Func&lt;int, Tuple&lt;int, T&gt;&gt; RunWithState;</span>
</span><span class='line'><span class="gi">+    public Func&lt;TState, Tuple&lt;TState, T&gt;&gt; RunWithState;</span>
</span><span class='line'> }
</span><span class='line'>
</span><span class='line'><span class="gd">-public static S&lt;U&gt; Bind&lt;T, U&gt;(S&lt;T&gt; m, Func&lt;T, S&lt;U&gt;&gt; k)</span>
</span><span class='line'><span class="gi">+public static S&lt;TState, U&gt; Bind&lt;TState, T, U&gt;(S&lt;TState, T&gt; m, Func&lt;T, S&lt;TState, U&gt;&gt; k)</span>
</span><span class='line'> {
</span><span class='line'><span class="gd">-    return new S&lt;U&gt; </span>
</span><span class='line'><span class="gi">+    return new S&lt;TState, U&gt; </span>
</span><span class='line'>     {
</span><span class='line'><span class="gu">@@ -102,3 +102,3 @@ public static S&lt;U&gt; Bind&lt;T, U&gt;(S&lt;T&gt; m, Func&lt;T, S&lt;U&gt;&gt; k)</span>
</span><span class='line'>         {
</span><span class='line'><span class="gd">-            Tuple&lt;int, T&gt; mResult = m.RunWithState(s0);</span>
</span><span class='line'><span class="gi">+            Tuple&lt;TState, T&gt; mResult = m.RunWithState(s0);</span>
</span><span class='line'>
</span><span class='line'><span class="gu">@@ -109,5 +109,5 @@ public static S&lt;U&gt; Bind&lt;T, U&gt;(S&lt;T&gt; m, Func&lt;T, S&lt;U&gt;&gt; k)</span>
</span><span class='line'>
</span><span class='line'><span class="gd">-public static S&lt;T&gt; Return&lt;T&gt;(T value)</span>
</span><span class='line'><span class="gi">+public static S&lt;TState, T&gt; Return&lt;TState, T&gt;(T value)</span>
</span><span class='line'> {
</span><span class='line'><span class="gd">-    return new S&lt;T&gt; </span>
</span><span class='line'><span class="gi">+    return new S&lt;TState, T&gt; </span>
</span><span class='line'>     {
</span><span class='line'><span class="gu">@@ -117,3 +117,3 @@ public static S&lt;T&gt; Return&lt;T&gt;(T value)</span>
</span><span class='line'>
</span><span class='line'><span class="gd">-public Tree&lt;Labeled&lt;T&gt;&gt; MLabel&lt;T&gt;(Tree&lt;T&gt; tree)</span>
</span><span class='line'><span class="gi">+public Tree&lt;StateContent&lt;int, T&gt;&gt; MLabel&lt;T&gt;(Tree&lt;T&gt; tree)</span>
</span><span class='line'> {
</span><span class='line'><span class="gu">@@ -122,3 +122,3 @@ public Tree&lt;Labeled&lt;T&gt;&gt; MLabel&lt;T&gt;(Tree&lt;T&gt; tree)</span>
</span><span class='line'>
</span><span class='line'><span class="gd">-public S&lt;Tree&lt;Labeled&lt;T&gt;&gt;&gt; MLabel1&lt;T&gt;(Tree&lt;T&gt; tree)</span>
</span><span class='line'><span class="gi">+public S&lt;int, Tree&lt;StateContent&lt;int, T&gt;&gt;&gt; MLabel1&lt;T&gt;(Tree&lt;T&gt; tree)</span>
</span><span class='line'> {
</span><span class='line'><span class="gu">@@ -128,3 +128,3 @@ public S&lt;Tree&lt;Labeled&lt;T&gt;&gt;&gt; MLabel1&lt;T&gt;(Tree&lt;T&gt; tree)</span>
</span><span class='line'>
</span><span class='line'><span class="gd">-        var updateState = new S&lt;int&gt; </span>
</span><span class='line'><span class="gi">+        var updateState = new S&lt;int, int&gt; </span>
</span><span class='line'>         {
</span><span class='line'><span class="gu">@@ -134,3 +134,3 @@ public S&lt;Tree&lt;Labeled&lt;T&gt;&gt;&gt; MLabel1&lt;T&gt;(Tree&lt;T&gt; tree)</span>
</span><span class='line'>         return Bind(updateState,
</span><span class='line'><span class="gd">-                    label =&gt; Return(leaf(labeled(label, lf.Value))));</span>
</span><span class='line'><span class="gi">+                    label =&gt; Return&lt;int, Tree&lt;StateContent&lt;int, T&gt;&gt;&gt;(leaf(stateContent(label, lf.Value))));</span>
</span><span class='line'>     }
</span><span class='line'><span class="gu">@@ -142,3 +142,3 @@ public S&lt;Tree&lt;Labeled&lt;T&gt;&gt;&gt; MLabel1&lt;T&gt;(Tree&lt;T&gt; tree)</span>
</span><span class='line'>                     left =&gt; Bind(MLabel1(br.Right),
</span><span class='line'><span class="gd">-                                 right =&gt; Return(branch(left, right))));</span>
</span><span class='line'><span class="gi">+                                 right =&gt; Return&lt;int, Tree&lt;StateContent&lt;int, T&gt;&gt;&gt;(branch(left, right))));</span>
</span><span class='line'>     }
</span></code></pre></td></tr></table></div></figure>


<p>It was an easy one this time, which sets the foundation for the next exercise, but we&#8217;ll come to it in the next post. The source code after this change is in the same old gist at <a href="https://gist.github.com/simoneb/5332234/b8e4d6afc501ff4dd74de6b9e7e8c2d5548e81b4">this revision</a>.</p>

<p>Stay tuned!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/03/31/labeling-trees-invisible-state/">Labeling Trees - Invisible State</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-31T01:45:00+01:00" pubdate data-updated="true">Mar 31<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is the second post of a series about labeling trees. In the <a href="/blog/2013/03/17/labeling-trees-introduction">previous post</a> we saw how to mark leaves of a binary tree with integer, incrementing labels, first manually and then functionally without relying on mutable state. We achieved it by writing a recursive <code>Label1</code> function which threaded the value of the label, the <em>state</em>, via function arguments and return value, incrementing it every time it came across a leaf of the tree.</p>

<p>Let&#8217;s review the signature of the <code>Label1</code> function and then move one step forward towards a different, less explicit way to pass the state around.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;</span> <span class="n">Label1</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="kt">int</span> <span class="n">label</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">tree</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As the signature clearly shows the state passing is visible both in the arguments and the return value of the function. There is certainly a good reason for that: if we need to increment the label and use the new value whenever we come across the next leaf would it be possible to do otherwise? Let&#8217;s as well review the part of the function which took care of applying labels to the leaves.</p>

<figure class='code'><figcaption><span>Label1 leaf logic  (label1-leaves.cs)</span> <a href='/downloads/code/monads/label1-leaves.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">lf</span> <span class="p">=</span> <span class="n">tree</span> <span class="k">as</span> <span class="n">Leaf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;;</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">label</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">leaf</span><span class="p">(</span><span class="n">labeled</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">lf</span><span class="p">.</span><span class="n">Value</span><span class="p">)));</span>
</span></code></pre></td></tr></table></div></figure>


<p>This simple code mixes together two concerns: creating a labeled leaf and incrementing the value of the label, squeezing them into a tuple. Let&#8217;s try to abstract and extract these two responsibilities and then apply a series of simple transformations over them, while keeping the behavior unchanged.</p>

<h4>First transformation: from integer to tuple</h4>

<figure class='code'><figcaption><span>Label1 first transformation  (label1-leaves-transformation-1.cs)</span> <a href='/downloads/code/monads/label1-leaves-transformation-1.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// previous:    int</span>
</span><span class='line'><span class="c1">// current:     Tuple&lt;int, int&gt;</span>
</span><span class='line'><span class="kt">var</span> <span class="n">newAndOldLabel</span> <span class="p">=</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">label</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">label</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">newAndOldLabel</span><span class="p">.</span><span class="n">Item1</span><span class="p">,</span> <span class="n">leaf</span><span class="p">(</span><span class="n">labeled</span><span class="p">(</span><span class="n">newAndOldLabel</span><span class="p">.</span><span class="n">Item2</span><span class="p">,</span> <span class="n">lf</span><span class="p">.</span><span class="n">Value</span><span class="p">)));</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we extracted the increment concern as a standalone operation. <code>newAndOldLabel</code> is a tuple whose first item contains the new value of the label and the second item contains the previous, unchanged value. The second statement simply uses it to create the final tuple.</p>

<h4>Second transformation: from tuple to functions returning tuples</h4>

<figure class='code'><figcaption><span>Label1 second transformation  (label1-leaves-transformation-2.cs)</span> <a href='/downloads/code/monads/label1-leaves-transformation-2.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// previous:    Tuple&lt;int, Tree&lt;Labeled&lt;T&gt;&gt;&gt;</span>
</span><span class='line'><span class="c1">// current:     Tuple&lt;int, int&gt; =&gt; Tuple&lt;int, Tree&lt;Labeled&lt;T&gt;&gt;&gt;</span>
</span><span class='line'><span class="n">Func</span><span class="p">&lt;</span><span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">labelLeaf</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">arguments</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">arguments</span><span class="p">.</span><span class="n">Item1</span><span class="p">,</span> <span class="n">leaf</span><span class="p">(</span><span class="n">labeled</span><span class="p">(</span><span class="n">arguments</span><span class="p">.</span><span class="n">Item2</span><span class="p">,</span> <span class="n">lf</span><span class="p">.</span><span class="n">Value</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nf">labelLeaf</span><span class="p">(</span><span class="n">newAndOldLabel</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we wrap the last statement from the previous step into a function which accesses <code>newAndOldLabel</code> via its arguments (rather than via local variables) and returns the result of invoking the function itself with <code>newAndOldLabel</code>.</p>

<h4>Third transformation: from anything to functions</h4>

<figure class='code'><figcaption><span>Label1 third transformation  (label1-leaves-transformation-3.cs)</span> <a href='/downloads/code/monads/label1-leaves-transformation-3.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="c1">// previous:    Tuple&lt;int, int&gt;</span>
</span><span class='line'><span class="c1">// current:     int =&gt; Tuple&lt;int, int&gt;</span>
</span><span class='line'><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;&gt;</span> <span class="n">bumpLabel</span> <span class="p">=</span> <span class="n">s</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">s</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// previous:    Tuple&lt;int, int&gt; =&gt; Tuple&lt;int, Tree&lt;Labeled&lt;T&gt;&gt;&gt;</span>
</span><span class='line'><span class="c1">// current:     int =&gt; int =&gt; Tuple&lt;int, Tree&lt;Labeled&lt;T&gt;&gt;&gt;</span>
</span><span class='line'><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;&gt;&gt;</span> <span class="n">labelLeafCurried</span> <span class="p">=</span>
</span><span class='line'>    <span class="n">labelValue</span> <span class="p">=&gt;</span> <span class="n">s</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">leaf</span><span class="p">(</span><span class="n">labeled</span><span class="p">(</span><span class="n">labelValue</span><span class="p">,</span> <span class="n">lf</span><span class="p">.</span><span class="n">Value</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'><span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;</span> <span class="n">bumpResult</span> <span class="p">=</span> <span class="n">bumpLabel</span><span class="p">(</span><span class="n">label</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nf">labelLeafCurried</span><span class="p">(</span><span class="n">bumpResult</span><span class="p">.</span><span class="n">Item2</span><span class="p">)(</span><span class="n">bumpResult</span><span class="p">.</span><span class="n">Item1</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we apply a transformation to both the label increment and the leaf-labeling logic. In the first case we wrap the creation of the <code>newAndOldLabel</code> tuple into a function which rather than grabbing the value of the label from the integer <code>label</code> argument of the containing function accesses it via its own argument.<br/>
In the second case we <em>curry</em> the already existing function so that instead of accepting a tuple argument it accepts a single integer argument and returns a function which accepts another integer argument and finally returns our output tuple. The external function takes care of fixing the <em>current</em> value used to apply a label to the leaf, while the inner function fixes the <em>new</em>, incremented label value as the first item of the resulting tuple.</p>

<p>The rest of the code <em>binds</em> together these two functions in a way which preserves the overall behavior.</p>

<h4>Fourth transformation: Bind</h4>

<p>As we just mentioned binding, let&#8217;s finally abstract this concept into its own <code>Bind</code> generic function. This function basically encapsulates the logic of composing <code>bumpLabel</code> and <code>labelLeafCurried</code> from the previous transformation.</p>

<figure class='code'><figcaption><span>Label1 fourth transformation  (label1-leaves-transformation-4.cs)</span> <a href='/downloads/code/monads/label1-leaves-transformation-4.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">return</span> <span class="nf">Bind</span><span class="p">(</span><span class="n">bumpLabel</span><span class="p">,</span> <span class="n">labelLeafCurried</span><span class="p">)(</span><span class="n">label</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Before looking at its definition let&#8217;s observe some of the characteristics of this function. It takes two functions as its arguments and returns a third function, which is then executed passing <code>label</code> as its only argument. Knowing both the signatures of the input functions and the return type of the containing <code>Label1</code> function implies that we also know the signature of the <code>Bind</code> function. Furthermore, being a replacement for the last few lines of code from the previous step means that the body will encapsulate the same logic in some form.</p>

<figure class='code'><figcaption><span>Bind  (bind-tuples.cs)</span> <a href='/downloads/code/monads/bind-tuples.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">Bind</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">&gt;&gt;</span> <span class="n">m</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;&gt;&gt;</span> <span class="n">k</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">s0</span> <span class="p">=&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">mResult</span> <span class="p">=</span> <span class="n">m</span><span class="p">(</span><span class="n">s0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">kResult</span> <span class="p">=</span> <span class="n">k</span><span class="p">(</span><span class="n">mResult</span><span class="p">.</span><span class="n">Item2</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nf">kResult</span><span class="p">(</span><span class="n">mResult</span><span class="p">.</span><span class="n">Item1</span><span class="p">);</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The important thing to note is that we&#8217;ve come here by applying some simple and logical transformations to the initial code, and if you try to follow what this code is doing you can realize that the behavior is unchanged. One final step to abstract this even more is to make it generic over the second item of the tuples involved, thus leading to a new signature (the body is unchanged).</p>

<figure class='code'><figcaption><span>Generic Bind  (bind-tuples-generic.cs)</span> <a href='/downloads/code/monads/bind-tuples-generic.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">U</span><span class="p">&gt;&gt;</span> <span class="n">Bind</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="p">&gt;(</span>
</span><span class='line'>    <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">m</span><span class="p">,</span>
</span><span class='line'>    <span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">U</span><span class="p">&gt;&gt;&gt;</span> <span class="n">k</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Fifth transformation: S type</h4>

<p>The signature of our <code>Bind</code> function is a mouthful, but we can see that there&#8217;s a recurring pattern in there. Specifically, we can see occurrences of <code>Func&lt;int, Tuple&lt;int, X&gt;&gt;</code> again and again. Let&#8217;s encapsulate this into a generic type <code>S&lt;T&gt;</code> which will have a single member of that function type, arbitrarily named <code>RunWithState</code>.</p>

<figure class='code'><figcaption><span>Empty S<T> class  (s-class-empty.cs)</span> <a href='/downloads/code/monads/s-class-empty.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">class</span> <span class="nc">S</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">public</span> <span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">RunWithState</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s as well rewrite <code>Bind</code> in terms of <code>S</code>.</p>

<figure class='code'><figcaption><span>Bind  (bind.cs)</span> <a href='/downloads/code/monads/bind.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">U</span><span class="p">&gt;</span> <span class="n">Bind</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="p">&gt;(</span><span class="n">S</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">m</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">U</span><span class="p">&gt;&gt;</span> <span class="n">k</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">U</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">RunWithState</span> <span class="p">=</span> <span class="n">s0</span> <span class="p">=&gt;</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">mResult</span> <span class="p">=</span> <span class="n">m</span><span class="p">.</span><span class="n">RunWithState</span><span class="p">(</span><span class="n">s0</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">return</span> <span class="nf">k</span><span class="p">(</span><span class="n">mResult</span><span class="p">.</span><span class="n">Item2</span><span class="p">).</span><span class="n">RunWithState</span><span class="p">(</span><span class="n">mResult</span><span class="p">.</span><span class="n">Item1</span><span class="p">);</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we can apply one additional transformation to our <code>Label1</code> function by rewriting everything in terms of <code>S</code>.</p>

<figure class='code'><figcaption><span>Label1 fifth transformation  (label1-leaves-transformation-5.cs)</span> <a href='/downloads/code/monads/label1-leaves-transformation-5.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">var</span> <span class="n">bumpLabelS</span> <span class="p">=</span> <span class="k">new</span> <span class="n">S</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">RunWithState</span> <span class="p">=</span> <span class="n">s0</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">s0</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;&gt;</span> <span class="n">labelLeafS</span> <span class="p">=</span> <span class="n">labelValue</span> <span class="p">=&gt;</span> <span class="k">new</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="n">RunWithState</span> <span class="p">=</span> <span class="n">s1</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">leaf</span><span class="p">(</span><span class="n">labeled</span><span class="p">(</span><span class="n">labelValue</span><span class="p">,</span> <span class="n">lf</span><span class="p">.</span><span class="n">Value</span><span class="p">)))</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">return</span> <span class="nf">Bind</span><span class="p">(</span><span class="n">bumpLabelS</span><span class="p">,</span> <span class="n">labelLeafS</span><span class="p">).</span><span class="n">RunWithState</span><span class="p">(</span><span class="n">label</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Sixth transformation: Return</h4>

<p>We can finally observe one more pattern in how the <code>labelLeafS</code> function creates an instance of the <code>S</code> type. You can see that the only value this instance depends on is the labeled leaf created inside its <code>RunWithState</code> function, which is of exactly the same type as the generic argument of the instance <code>S&lt;Tree&lt;Labeled&lt;T&gt;&gt;&gt;</code>. Not that we benefit much from it now, but let&#8217;s extract this pattern into a <code>Return</code> method, which given a <code>T</code>, returns an instance of <code>S&lt;T&gt;</code>.</p>

<figure class='code'><figcaption><span>Return  (return.cs)</span> <a href='/downloads/code/monads/return.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="k">static</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">Return</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="k">value</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="k">new</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="n">RunWithState</span> <span class="p">=</span> <span class="n">s</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="k">value</span><span class="p">)</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s also rewrite the relevant part of the <code>Label1</code> function in terms of <code>Return</code>, additionally inlining the <code>labelLeafS</code> function.</p>

<figure class='code'><figcaption><span>Label1 sixth transformation  (label1-leaves-transformation-6.cs)</span> <a href='/downloads/code/monads/label1-leaves-transformation-6.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">return</span> <span class="nf">Bind</span><span class="p">(</span><span class="n">bumpLabelS</span><span class="p">,</span>
</span><span class='line'>            <span class="n">labelValue</span> <span class="p">=&gt;</span> <span class="n">Return</span><span class="p">(</span><span class="n">leaf</span><span class="p">(</span><span class="n">labeled</span><span class="p">(</span><span class="n">labelValue</span><span class="p">,</span> <span class="n">lf</span><span class="p">.</span><span class="n">Value</span><span class="p">))))</span>
</span><span class='line'>       <span class="p">.</span><span class="n">RunWithState</span><span class="p">(</span><span class="n">label</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Hiding the state</h3>

<p>Before we move on and formalize the outcome of this long sequence of transformations in a new, named pattern let&#8217;s observe one important thing in the final version of our code. The final statement returns a value of type <code>Tuple&lt;int, Tree&lt;Labeled&lt;T&gt;&gt;&gt;</code> simply because we execute the <code>RunWithState</code> function of the <code>S&lt;Tree&lt;Labeled&lt;T&gt;&gt;&gt;</code> instance returned by <code>Bind</code>.  Executing this function is also the only occasion in which we use the integer <code>label</code> argument of the containing function <code>Label1</code>.</p>

<p>The observation is therefore: if rather than returning a <code>Tuple&lt;int, Tree&lt;Labeled&lt;T&gt;&gt;&gt;</code> we returned <code>S&lt;Tree&lt;Labeled&lt;T&gt;&gt;&gt;</code> then we wouldn&#8217;t need the <code>label</code> argument in <code>Label1</code> and shift to the caller the responsibility of executing <code>RunWithState</code> with the initial label value. In fact <code>Label</code>, the caller, is already doing that, just more explicitly via function arguments, but we can see that we have an opportunity to change the pattern of providing the initial state by moving from a function with this signature:</p>

<figure class='code'><figcaption><span>pseudo old signature</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="kt">int</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>To a function with this signature:</p>

<figure class='code'><figcaption><span>pseudo new signature</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="n">Tree</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="p">=&gt;</span> <span class="kt">int</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those familiar with functional programming will find that this is vaguely similar to currying, where a function of n arguments is transformed into n functions of 1 argument each.</p>

<p>We now have all the building blocks for rewriting our whole labeling functions <code>Label</code> and <code>Label1</code> from a completely new perspective, where the final outcome is the same but the means by which we get there are completely different. This also justifies creating two new functions called <code>MLabel</code> and <code>MLabel1</code>, respectively.</p>

<figure class='code'><figcaption><span>MLabel and MLabel1  (mlabel-and-mlabel1.cs)</span> <a href='/downloads/code/monads/mlabel-and-mlabel1.cs'>download</a></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='csharp'><span class='line'><span class="k">public</span> <span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;</span> <span class="n">MLabel</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Tree</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">tree</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="nf">MLabel1</span><span class="p">(</span><span class="n">tree</span><span class="p">).</span><span class="n">RunWithState</span><span class="p">(</span><span class="m">0</span><span class="p">).</span><span class="n">Item2</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">public</span> <span class="n">S</span><span class="p">&lt;</span><span class="n">Tree</span><span class="p">&lt;</span><span class="n">Labeled</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;&gt;&gt;</span> <span class="n">MLabel1</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">Tree</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">tree</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="n">tree</span> <span class="k">is</span> <span class="n">Leaf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">lf</span> <span class="p">=</span> <span class="n">tree</span> <span class="k">as</span> <span class="n">Leaf</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;;</span>
</span><span class='line'>
</span><span class='line'>        <span class="kt">var</span> <span class="n">updateState</span> <span class="p">=</span> <span class="k">new</span> <span class="n">S</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>            <span class="n">RunWithState</span> <span class="p">=</span> <span class="n">s0</span> <span class="p">=&gt;</span> <span class="n">Tuple</span><span class="p">.</span><span class="n">Create</span><span class="p">(</span><span class="n">s0</span> <span class="p">+</span> <span class="m">1</span><span class="p">,</span> <span class="n">s0</span><span class="p">)</span>
</span><span class='line'>        <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nf">Bind</span><span class="p">(</span><span class="n">updateState</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">labelValue</span> <span class="p">=&gt;</span> <span class="n">Return</span><span class="p">(</span><span class="n">leaf</span><span class="p">(</span><span class="n">labeled</span><span class="p">(</span><span class="n">labelValue</span><span class="p">,</span> <span class="n">lf</span><span class="p">.</span><span class="n">Value</span><span class="p">))));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="kt">var</span> <span class="n">br</span> <span class="p">=</span> <span class="n">tree</span> <span class="k">as</span> <span class="n">Branch</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="nf">Bind</span><span class="p">(</span><span class="n">MLabel1</span><span class="p">(</span><span class="n">br</span><span class="p">.</span><span class="n">Left</span><span class="p">),</span>
</span><span class='line'>                    <span class="n">left</span> <span class="p">=&gt;</span> <span class="n">Bind</span><span class="p">(</span><span class="n">MLabel1</span><span class="p">(</span><span class="n">br</span><span class="p">.</span><span class="n">Right</span><span class="p">),</span>
</span><span class='line'>                                 <span class="n">right</span> <span class="p">=&gt;</span> <span class="n">Return</span><span class="p">(</span><span class="n">branch</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">))));</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Together with <code>Bind</code>, <code>Return</code> and the type <code>S&lt;T&gt;</code> this is the bulk of the code required to label trees in this new way.</p>

<p>Now, although we have gone to great lengths talking about leaves, you might wonder why branches did not deserve their own considerations as I&#8217;ve included them in the code above already.<br/>
The reason is that as soon as you understand what we did with leaves it should be easy, even easier, to figure out what is happening with branches, as there is no state change involved. Before we try to understand the similarities I suggest you lookup the <a href="/blog/2013/03/17/labeling-trees-introduction#label">final version of the code</a> from the previous post.</p>

<p>The analogy should be more visible than it is for leaves, let&#8217;s explain in words. We bind a recursive call to <code>MLabel1</code> fed with the left tree of the branch to a function which takes the left labeled tree and binds another recursive call, this time fed with the right tree, to a function which takes the right labeled tree and <em>returns</em> an instance of the <em>state monad</em> created from a branch whose left tree is accessed via a closure and the right is the argument of the function itself.</p>

<p>Besides the mouthful, did I just say <em>state monad</em>? Ah right, the state monad is the triplet represented by <code>S&lt;T&gt;</code>, <code>Bind</code> and <code>Return</code>, while <code>MLabel</code> and <code>MLabel1</code> are just our logic to label a tree in a third way besides manually and functionally: <em>monadically</em>.</p>

<p>As for the state monad, we just invented it, but more on this in the next post.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>About me</h1>
  <p>
	<strong>Simone Busoli</strong>
	<br/>
	creative software engineer
  </p>
<!-- AddThis Follow BEGIN -->
<div class="addthis_toolbox addthis_32x32_style addthis_default_style">
<a class="addthis_button_twitter_follow" addthis:userid="simonebu"></a>
<a class="addthis_button_linkedin_follow" addthis:userid="simonebusoli"></a>
<a class="addthis_button_rss_follow" addthis:userid="http://feeds.feedburner.com/simoneb"></a>
</div>
<script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5143bd0a20061164"></script>
<!-- AddThis Follow END -->

</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2013/04/13/labeling-trees-exercise-2/">Labeling Trees - Exercise 2</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/04/07/labeling-trees-exercise-1/">Labeling Trees - Exercise 1</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/31/labeling-trees-invisible-state/">Labeling Trees - Invisible state</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/03/17/labeling-trees-introduction/">Labeling Trees - Introduction</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/01/19/async-support-in-nunit/">Async support in NUnit</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/simoneb">@simoneb</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'simoneb',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2013 - Simone Busoli -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'simoneb';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
